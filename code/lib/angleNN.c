#include "angleNN.h"
#include <stdio.h>

// Number of nodes in hidden layer
#define NUM_NODES 50

static int matmul(int r1, int c1, const double mat1[r1][c1], int r2, int c2, const double mat2[r2][c2], double result[r1][c2]);
static double relu(double x);

const double W1[NUM_NODES][ANGLE_NN_NUM_INPUTS] = 
{
    { 0.32400522,     0.59347755,    -0.4550447,      0.1103395,      0.071392484,    1.7329662,     -5.2477016,     -5.995041,      -1.970479,       0.17253232 },
    {-0.25083315,     0.10202199,    -0.28324264,    -0.21815819,     0.2315822,      0.20819858,     0.02849251,     0.17260998,     0.20856878,     0.22088781 },
    {-0.36464375,     0.43990836,     0.103821866,   -0.045257814,    0.03780396,    -2.084199,       8.098524,       4.01482,       -6.4209867,     -6.630199   },
    { 0.13913068,    -0.030551298,   -0.14037517,     0.15223742,    -0.19292814,    -0.056183487,   -0.017855855,   -0.20431317,     0.26780877,    -0.26253036 },
    { 0.12465286,     0.4494285,     -0.29499716,     0.11725501,     0.48926094,     1.8401811,     -5.7910147,     -6.337228,      -1.6584923,     -0.01856326 },
    {-0.6211599,      1.6852309,     -0.20656037,    -0.21377984,    -0.3109885,     -2.4757023,     11.124451,       2.3496215,     -14.148427,    -11.773359   },
    { 0.24295881,     0.01216355,    -0.264147,      -0.14123718,     0.040681094,   -0.31548136,     0.22221199,    -0.20102245,    -0.30217814,    -0.11225483 },
    { 0.06389251,     0.160415,      -0.36102182,     0.081927784,   -0.028795477,    0.11835364,    -0.040851876,    0.08176798,    -0.0368132,     -0.30580887 },
    {-0.26275772,     0.5490117,      0.045560576,    0.1291681,      0.11564901,     1.2392452,     -5.2796674,     -6.456324,      -1.7078327,     -0.018635953},
    {-0.14092165,    -0.20852593,     0.03255093,     0.14629662,    -0.018112332,   -0.11269416,    -0.16764858,    -0.102470204,   -0.016511708,   -0.28865832 },
    { 0.03940591,     0.6146825,     -0.3303332,      0.025607156,    0.33943582,     1.7747881,     -5.5616436,     -6.5505576,     -1.9856635,      0.17650862 },
    { 0.24699587,     0.1803661,     -0.3875038,      0.33508945,    -0.22953415,     1.4485372,     -5.1934094,      7.4192996,      9.247569,      -0.547997   },
    { 0.05815944,    -0.38050246,     0.5119852,      0.18176372,    -0.10603097,    -1.2190591,      5.967342,       6.7424726,      1.7588202,     -0.41589126 },
    {-0.14256339,     0.5353112,      0.13397945,     0.34894526,     0.31923425,     1.6744202,     -5.4192147,     -6.2246194,     -2.0001106,      0.06181565 },
    {-0.08394748,    -0.23716615,    -0.19703369,     0.2964472,     -0.27053517,    -0.03368908,    -0.19572635,    -0.131055,      -0.022753775,   -0.17874892 },
    { 0.22698006,     0.1027563,     -0.27643353,    -0.32020003,     0.113535814,   -0.36262795,    -0.092293784,   -0.21713337,     0.22203235,     0.08959585 },
    { 0.08788791,    -0.06314498,    -0.012974799,   -0.2143988,     -0.10094398,    -0.23448044,    -0.27189642,    -0.15551254,    -0.17148858,    -0.09441383 },
    { 0.24012259,    -0.23690626,    -0.25969985,    -0.13078547,     0.21730724,     0.011920631,   -0.22166812,    -0.30391943,    -0.096342504,    0.107147604},
    {-0.17540397,    -0.010891587,    0.2561902,     -0.011736214,   -0.21101637,     0.08138928,    -0.2706963,     -0.11974566,     0.055961102,   -0.17087245 },
    {-0.016636094,    0.3513489,     -0.33503777,     0.19883423,     0.529358,       1.6009275,     -5.8069963,     -6.2632227,     -2.0628376,      0.15829998 },
    {-0.057089746,   -0.1285001,     -0.2975535,     -0.24469844,    -0.30915952,    -0.24767676,    -0.11582394,     0.0407252,      0.24200472,     0.11228439 },
    {-0.25985107,     0.6684887,     -0.06790433,     0.013024119,    0.5077157,      1.1310073,     -5.76426,       -6.9032574,     -1.8253539,     -0.15863806 },
    { 0.07863055,    -0.2932414,      0.23180966,    -0.2393645,      0.09637753,    -0.0605139,     -0.0010123012,   0.040963214,    0.09513718,    -0.27976492 },
    { 0.29092768,     0.3833979,     -0.29755384,     0.05267544,     0.53451216,     1.3723295,     -5.62166,       -6.2825866,     -1.9805329,      0.12894078 },
    { 0.08560691,     0.32547328,     0.16210486,    -0.1511122,      0.17501129,     1.5774473,     -5.22952,       -6.2226367,     -1.867538,      -0.511633   },
    { 0.110333174,    0.44951847,     0.018219355,    0.06252466,     0.3119831,      1.7171677,     -5.330139,      -6.225944,      -1.6300768,     -0.20941319 },
    {-0.13625692,    -0.21260598,     0.25662908,    -0.16876209,    -0.08691615,    -0.0518499,      0.09785086,     0.10589546,     0.013447225,   -0.08793782 },
    { 0.343681,       0.22188099,     0.12805939,    -0.08130526,     0.23989578,     1.8816725,     -5.563263,      -6.4031057,     -1.7261788,     -0.5226909  },
    { 0.09302241,     0.3625341,     -0.20460859,     0.2787453,      0.15109803,     1.8362224,     -5.275197,      -6.5829806,     -2.1610205,     -0.07974614 },
    { 0.053768933,    0.24697748,    -0.2755309,     -0.2039206,     -0.062128812,   -0.11723004,     0.18560228,     0.20725033,     0.15745592,     0.14303783 },
    {-0.11270523,     0.2447237,     -0.12083541,    -0.23005259,    -0.30869502,    -0.13605508,    -0.284192,      -0.17378427,    -0.17731288,    -0.19779894 },
    { 0.11692214,     0.010260671,    0.047119588,   -0.19454733,    -0.20194934,    -0.06631872,    -0.029827148,   -0.043310344,    0.06655893,    -0.1546826  },
    {-0.07850611,    -0.12499809,    -0.17100967,     0.13393703,    -0.27591038,    -0.17976178,    -0.30503792,     0.2594162,     -0.21924388,    -0.048921734},
    {-0.23224542,     0.003678086,    0.029447468,   -0.03164642,     0.13768414,     0.16206916,     0.011375766,    0.018168233,   -0.060489338,    0.1463764  },
    { 0.2557691,     -0.28672615,     0.28390524,    -0.02247288,    -0.079497024,   -1.8783823,      5.8214664,      6.7392497,      2.2043676,      0.35009173 },
    { 0.1478293,      0.16423282,    -0.2894106,     -0.27133188,    -0.22200777,    -0.17091648,     0.22374395,    -0.03850445,    -0.31378213,     0.09034148 },
    {-0.25868866,     0.08755028,     0.1614666,     -0.19804692,    -0.07408331,     0.03384599,     0.0009949803,   0.1594379,      0.05387914,     0.015890926},
    {-0.12973388,     0.5939344,     -0.038890254,    0.250611,       0.03221909,     1.2816672,     -5.3931336,     -6.035497,      -2.0065072,     -0.32043788 },
    { 0.2790588,     -0.31390774,     0.10263418,    -0.12522702,    -0.051543146,   -0.13823633,    -0.20756623,    -0.12740277,    -0.2069015,     -0.2298453  },
    {-0.052378252,   -0.31051546,    -0.22033304,     0.17703168,     0.2276524,     -0.22896232,    -0.10009615,     0.272461,      -0.15289266,     0.29729253 },
    {-0.18151464,     0.20273356,     0.22009909,    -0.18119633,    -0.28171128,     0.20403492,     0.27198112,    -0.026410664,   -0.30729213,    -0.096541286},
    { 0.93693274,    -0.34263244,    -1.3034651,      0.1907039,      1.0066288,     -1.53232,       -3.9740815,     -3.0949938,     -2.5662491,      2.1636395  },
    {-0.25392473,     0.7187422,     -0.17905793,    -0.15305822,     0.5188458,      1.5466502,     -5.5789485,     -6.558161,      -1.8577945,     -0.052805662},
    { 0.71733093,    -1.3273748,      0.07404217,     0.01794436,     0.726126,      -6.4263067,     -2.867749,      10.940924,       5.0719004,      3.5879269  },
    {-0.14559995,     0.27736858,    -0.025703527,   -0.14937787,    -0.22373256,    -0.24623242,    -0.15553558,    -0.14745763,     0.14825702,    -0.003213015},
    { 0.41466114,    -0.5598659,      0.4981324,      0.21065041,    -0.15753318,    -1.2530143,      5.5380144,      6.6483135,      2.0790732,      0.12366189 },
    {-0.08184603,     0.6746564,      0.07395075,     0.086728744,    0.05718887,     1.6701796,     -5.7292914,     -5.8261213,     -1.7379354,     -0.09145675 },
    { 0.23385148,     0.70564306,    -0.38772643,     0.16366422,     0.12624736,     1.2952867,     -5.693455,      -6.7490687,     -1.6012352,      0.16177158 },
    {-0.2667828,     -0.1523701,      0.16792625,    -0.114049375,    0.07257405,    -0.280166,       0.015683204,    0.22737393,    -0.3101889,     -0.033296347},
    {-0.14092165,    -0.3007001,      0.2655615,     -0.048492283,   -0.19877154,     0.13794795,    -0.20925945,     0.16069749,     0.07276195,     0.25982705 }
};

const double B1[NUM_NODES] = 
{
     5.31087,
     0.0,
    -5.73466,
    -0.01499,
     5.284145,
    -5.8404,
     0.0,
    -0.10081,
     5.325247,
     0.0,
     5.303657,
    -8.2351,
    -5.20741,
     5.25672,
     0.0,
    -0.0523,
     0.0,
     0.0,
     0.0,
     5.297,
     0.0,
     5.222348,
    -0.03068,
     5.260582,
     5.345898,
     5.260414,
     0.0,
     5.299528,
     5.312687,
     0.0,
     0.0,
     0.0,
     0.0,
    -0.03073,
    -5.24133,
     0.0,
     0.0,
     5.296126,
    -0.02942,
    -0.01853,
    -0.02855,
    -5.75854,
     5.319131,
    -5.5455,
    -0.0075,
    -5.02295,
     5.288332,
     5.285922,
     0.0,
     0.0,
};

const double W2[1][NUM_NODES + 1] = 
{
    {1.9645046, 0.3336902, -4.004117, -0.014077924, 1.5097946, -9.82771, 0.14256993, -0.18472289, 1.6865896, -0.019283801, 1.6582689, -13.762188, -2.3154, 0.8571845, -0.31150815, -0.27877733, 0.18226263, -0.09502566, -0.050259024, 1.8179651, 0.2966502, 1.0188458, -0.1780482, 0.9726746, 1.2085735, 0.792819, -0.231706, 1.1815763, 1.4991963, -0.013987601, 0.19060811, 0.14000738, -0.29275516, -0.07788913, -2.4456663, -0.09395446, -0.039942443, 1.1541082, -0.31500635, 0.13785885, -0.19498983, -12.867475, 1.6988599, -16.540213, -0.003993304, -2.6659877, 1.1158257, 1.285869, -0.1612324, -0.30351374}
};

const double B2[1] = {5.320895};

// Predicts the angle based on the input data
// Input must have a 1 added as first element to accomodate the bias node
double angleNN_predict(double input[ANGLE_NN_NUM_INPUTS][1])
{
    // Calculate inputs to hidden layer
    double A2[NUM_NODES][1];
    // Perform W1*A1
    int status = matmul(NUM_NODES, ANGLE_NN_NUM_INPUTS, W1, ANGLE_NN_NUM_INPUTS, 1, input, A2);
    if (status != 0)
    {
         printf("\tERROR: Matrix sizes incompatible\n");
         return -1;
    }
    // Handle the bias nodes and activation functions
    for (int i = 0; i < NUM_NODES; ++i)
    {
        // Add bias node input
        A2[i][0] += B1[i];

        // Apply activation function
        A2[i][0] = relu(A2[i][0]);
    }

    // Calculate inputs to output layer
    double A3[1][1];
    // Perform W2*A2
    status = matmul(1, NUM_NODES, W2, NUM_NODES, 1, A2, A3);
    if (status != 0)
    {
         printf("\tERROR: Matrix sizes incompatible\n");
         return -1;
    }
    // Handle the bias nodes and activation functions
    for (int i = 0; i < 1; ++i)
    {
        // Add bias node input
        A3[i][0] += B2[i];

        // Apply activation function
        A3[i][0] = relu(A3[i][0]);
    }

    return A3[0][0];
}

// Multiplys two matrices
// rx and cx are the number of rows and columns, respectively, of matx
// Resulting matrix is stored in result
// Returns -1 if matrix dimensions are incompatible. Otherwise returns 0
static int matmul(int r1, int c1, const double mat1[r1][c1], int r2, int c2, const double mat2[r2][c2], double result[r1][c2])
{
    // Make sure the dimensions are compatible
    if (c1 != r2)
    {
        return -1;
    }

    // Loop through each row of mat1
    for (int i = 0; i < r1; ++i)
    {
        // Loop through each column of mat2
        for (int j = 0; j < c2; ++j)
        {
            result[i][j] = 0;

            // Loop through the elements and multiply them
            for (int k = 0; k < c1; ++k)
            {
                result[i][j] += mat1[i][k]*mat2[k][j];
            }
        }
    }

    // Return 0 to indicate success
    return 0;
}

static double relu(double x)
{
    if (x < 0)
    {
        return 0;
    }
    else
    {
        return x;
    }
}
